#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å·¥å…·å‡½æ•°æ¨¡å—

è¯¥æ¨¡å—åŒ…å«åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„å„ç§è¾…åŠ©å·¥å…·å‡½æ•°ï¼ŒåŒ…æ‹¬ï¼š
1. æ—¥å¿—é…ç½®è®¾ç½®
2. ç³»ç»Ÿæ¨ªå¹…æ‰“å°
3. ä¿¡å·å¤„ç†å™¨è®¾ç½®
4. ç”¨æˆ·è¾“å…¥å¤„ç†
"""

# å¯¼å…¥å¿…è¦çš„æ¨¡å—
import logging
import sys
import signal
from typing import Any, Optional

def setup_logging(level: int = logging.INFO) -> logging.Logger:
    """è®¾ç½®æ—¥å¿—é…ç½®
    
    é…ç½®åº”ç”¨ç¨‹åºçš„æ—¥å¿—è®°å½•ï¼ŒåŒ…æ‹¬æ—¥å¿—çº§åˆ«ã€æ ¼å¼å’Œè¾“å‡ºä½ç½®ã€‚
    
    Args:
        level: æ—¥å¿—çº§åˆ«ï¼Œé»˜è®¤å€¼ä¸ºlogging.INFO
        
    Returns:
        logging.Logger: é…ç½®å¥½çš„æ—¥å¿—è®°å½•å™¨å®ä¾‹
    """
    logging.basicConfig(
        level=level,                         # è®¾ç½®æ—¥å¿—çº§åˆ«
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',  # æ—¥å¿—æ ¼å¼
        handlers=[
            logging.StreamHandler(sys.stdout),  # è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
            logging.FileHandler('mem0_chat.log', encoding='utf-8')  # è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶
        ]
    )
    return logging.getLogger(__name__)  # è¿”å›å½“å‰æ¨¡å—çš„æ—¥å¿—è®°å½•å™¨

def print_banner():
    """æ‰“å°ç³»ç»Ÿæ¨ªå¹…
    
    æ‰“å°åŒ…å«ç³»ç»ŸåŠŸèƒ½ç‰¹ç‚¹å’Œå‘½ä»¤è¯´æ˜çš„æ¬¢è¿æ¨ªå¹…ã€‚
    """
    banner = """
    ğŸ§  è®°å¿†å¢å¼ºèŠå¤©ç³»ç»Ÿ
    ========================================
    åŠŸèƒ½ç‰¹ç‚¹:
    â€¢ åŸºäºé•¿æœŸè®°å¿†çš„ä¸ªæ€§åŒ–å›å¤
    â€¢ å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ä¿æŒ  
    â€¢ å¤šç”¨æˆ·è®°å¿†éš”ç¦»
    â€¢ è‡ªåŠ¨è®°å¿†å­˜å‚¨å’Œæ£€ç´¢
    â€¢ å¤šä»£ç†ä¸“å®¶ååŒï¼šé¡¹ç›®å¤§è„‘ + ä¸“å®¶å¤§è„‘
    ========================================
    å‘½ä»¤è¯´æ˜:
    â€¢ ç›´æ¥è¾“å…¥æ¶ˆæ¯å¼€å§‹èŠå¤©
    â€¢ 'stats' - æŸ¥çœ‹å¯¹è¯ä¸ä¸Šä¸‹æ–‡ç»Ÿè®¡
    â€¢ 'clear' - æ¸…ç©ºå½“å‰å¯¹è¯å†å²
    â€¢ 'user <ç”¨æˆ·ID>' - åˆ‡æ¢ç”¨æˆ·
    â€¢ 'agent <ä»£ç†ID>' - åˆ‡æ¢ä»»åŠ¡ä»£ç†
    â€¢ 'agents' - æŸ¥çœ‹æ‰€æœ‰å¯ç”¨ä»£ç†
    â€¢ 'session <ä¼šè¯ID>' - åˆ‡æ¢æˆ–åˆ›å»ºæ–°ä¼šè¯
    â€¢ 'exit' - é€€å‡ºç³»ç»Ÿ
    â€¢ Ctrl+C - å¼ºåˆ¶é€€å‡º
    ========================================
    """
    print(banner)

def setup_signal_handlers():
    """è®¾ç½®ä¿¡å·å¤„ç†å™¨ï¼Œç¡®ä¿Ctrl+Cå¯ä»¥æ­£å¸¸é€€å‡º
    
    é…ç½®SIGINTä¿¡å·å¤„ç†å™¨ï¼Œä½¿ç³»ç»Ÿèƒ½å¤Ÿä¼˜é›…åœ°å“åº”Ctrl+Cå‘½ä»¤ã€‚
    """
    def signal_handler(signum, frame):
        """ä¿¡å·å¤„ç†å‡½æ•°
        
        Args:
            signum: æ¥æ”¶åˆ°çš„ä¿¡å·ç¼–å·
            frame: å½“å‰çš„å †æ ˆå¸§
        """
        print("\n\næ¥æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨é€€å‡ºç³»ç»Ÿ...")
        sys.exit(0)
    
    signal.signal(signal.SIGINT, signal_handler)  # è®¾ç½®SIGINTä¿¡å·å¤„ç†å™¨

def handle_user_input(prompt: str) -> Optional[str]:
    """å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œæ”¯æŒä¸­æ–‡å’ŒCtrl+C
    
    å®‰å…¨åœ°è·å–ç”¨æˆ·è¾“å…¥ï¼Œå¤„ç†å„ç§å¯èƒ½çš„å¼‚å¸¸æƒ…å†µã€‚
    
    Args:
        prompt: è¾“å…¥æç¤ºå­—ç¬¦ä¸²
        
    Returns:
        Optional[str]: ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯åˆ™è¿”å›None
    """
    try:
        user_input = input(prompt).strip()  # è·å–ç”¨æˆ·è¾“å…¥å¹¶å»é™¤é¦–å°¾ç©ºç™½
        return user_input
    except (KeyboardInterrupt, EOFError):
        # å¤„ç†Ctrl+Cå’Œæ–‡ä»¶ç»“æŸç¬¦
        print("\n\næ¥æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨é€€å‡ºç³»ç»Ÿ...")
        sys.exit(0)
    except UnicodeDecodeError:
        # å¤„ç†ç¼–ç é”™è¯¯
        print("\nâŒ è¾“å…¥ç¼–ç é”™è¯¯ï¼Œè¯·é‡è¯•")
        return None
    except Exception as e:
        # å¤„ç†å…¶ä»–æœªçŸ¥é”™è¯¯
        logging.error(f"è¾“å…¥å¤„ç†é”™è¯¯: {e}")
        return None